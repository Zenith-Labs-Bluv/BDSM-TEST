<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>테스트 결과</title>
    <style>
        :root {
            --primary-color: #7B6CFF;
            --gradient-color: linear-gradient(135deg, #7B6CFF, #6C9FFF);
            --bg-color: #050505;
            --card-bg: #1A1A1A;
            --text-color: #FFFFFF;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Pretendard', sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .smartphone-mockup {
            width: 360px;
            height: 800px;
            padding: 20px;
            border-radius: 40px;
            background: var(--card-bg);
            box-shadow: 0 0 60px rgba(0, 0, 0, 0.5);
            position: relative;
            box-sizing: border-box;
            overflow-y: auto;
        }

        .result-image-container {
            width: 100%;
            height: 400px;
            background: rgba(123, 108, 255, 0.05);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .result-image {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .placeholder-text {
            color: var(--primary-color);
            font-size: 14px;
            opacity: 0.7;
        }

        .button-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 20px;
        }

        .action-button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .primary-button {
            background: var(--gradient-color);
            color: white;
        }

        .secondary-button {
            background: rgba(123, 108, 255, 0.1);
            color: var(--primary-color);
        }

        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--card-bg);
            padding: 20px;
            border-radius: 20px;
            z-index: 1000;
            width: 80%;
            max-width: 300px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .modal-content {
            margin-bottom: 20px;
            color: var(--text-color);
            font-size: 16px;
            line-height: 1.5;
        }

        .modal-button {
            background: var(--gradient-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 100px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }

        .restart-container {
            text-align: center;
            margin-top: 40px;
            margin-bottom: 20px;
        }

        .restart-button {
            width: 40px;
            height: 40px;
            background: rgba(123, 108, 255, 0.1);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
        }

        .restart-button svg {
            width: 24px;
            height: 24px;
            fill: var(--primary-color);
        }

        .restart-hint {
            color: var(--primary-color);
            font-size: 14px;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="smartphone-mockup">
        <!-- 결과 이미지 컨테이너 -->
        <div class="result-image-container">
            <img id="resultImage" src="" alt="테스트 결과" class="result-image">
            <span class="placeholder-text">결과 이미지가 이곳에 표시됩니다</span>
        </div>
        
        <!-- 버튼 컨테이너 -->
        <div class="button-container">
            <button class="action-button primary-button" onclick="goToBluv()">
                BLUV 서비스 알아보기
            </button>
            <button class="action-button secondary-button" onclick="saveImage()">
                이미지 저장하기
            </button>
            <button class="action-button secondary-button" onclick="shareTest()">
                친구에게 테스트 공유하기
            </button>
        </div>


        <!-- 이미지저장 아이콘 버튼 추가 -->
        <!--div class="restart-container"></div>
            <button class="restart-button" onclick="restartTest()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#ffffff">
                    <circle cx="12" cy="12" r="12" fill="#5c6bc0" />
                    <path d="M12 3v12m0 0l4-4m-4 4l-4-4" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
            </button>
            <div class="restart-hint">테스트 다시하기</div>
        </div>-->

        <!-- 링크공유 아이콘 버튼 추가 -->
        <!--div class="restart-container"></div>
            <button class="restart-button" onclick="restartTest()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#ffffff">
                    <circle cx="12" cy="12" r="12" fill="#ab47bc" /> 
                    <path d="M15 8a2 2 0 11-4 0 2 2 0 014 0zm-5.91 5.09a2 2 0 100 4 2 2 0 000-4zm7.82 0a2 2 0 100 4 2 2 0 000-4z" fill="#ffffff"/>
                    <path d="M9.17 14.83l5.66-2.83M9.17 9.17l5.66 2.83" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>                  
            </button>
            <div class="restart-hint">테스트 다시하기</div>
        </div>

        <!-- 테스트 다시하기 아이콘 버튼 추가 -->
        <div class="restart-container">
            <button class="restart-button" onclick="restartTest()">
                <svg viewBox="0 0 24 24">
                    <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                </svg>
            </button>
            <div class="restart-hint">다시하기</div>
        </div>
    </div>

    <!-- 모달 구조 수정 -->
    <div class="modal-overlay" id="modalOverlay"></div>
    <div class="modal" id="warningModal">
        <div class="modal-content" id="modalMessage"></div>
        <button class="modal-button" onclick="closeModal()">확인</button>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-storage-compat.js"></script>

    <script>
        // Firebase 구성
        const firebaseConfig = {
            apiKey: "AIzaSyD_CHtoN2qgDHj5JRxUOzeyc9eSyP11tO4",
            authDomain: "bluv-test.firebaseapp.com",
            projectId: "bluv-test",
            storageBucket: "bluv-test.firebasestorage.app",
            messagingSenderId: "1090738855249",
            appId: "1:1090738855249:web:980200f35ddffdf0a04770",
            measurementId: "G-1TBGY1H1CC"
        };

        // Firebase 초기화
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();

        // 결과 이미지 가져오기 함수
        async function getResultImage(tendency, topTendency) {
            try {
                // tendency는 'dom' 또는 'sub'
                // topTendency는 최고 점수를 받은 성향 (예: 'master_mistress' 또는 'slave')
                const imagePath = `result_images/${tendency}/${topTendency}.png`;
                const imageUrl = await storage.ref(imagePath).getDownloadURL();
                return imageUrl;
            } catch (error) {
                console.error('이미지 로드 실패:', error);
                return null;
            }
        }

        // 상위 2개 성향 찾기 함수
        function getTopTendencies(scores) {
            const tendencyScores = Object.entries(scores).filter(
                ([tendency]) => tendency !== 'dom_vanilla' && tendency !== 'sub_vanilla'
            );
            tendencyScores.sort(([, a], [, b]) => b - a);
            
            return {
                topTendency: tendencyScores[0][0],
                topScore: tendencyScores[0][1],
                secondTendency: tendencyScores[1][0],
                secondScore: tendencyScores[1][1]
            };
        }

        // 결과 처리 및 저장
        async function processTestResult() {
            try {
                const gender = localStorage.getItem('userGender');
                const tendency = localStorage.getItem('userTendency');
                const scores = JSON.parse(localStorage.getItem(
                    tendency === 'dom' ? 'domScores' : 'subScores'
                ));
                
                const topResults = getTopTendencies(scores);
                
                // 이미지 표시
                displayResultImage(gender, tendency, topResults.topTendency);
                
                // Firestore에 데이터 저장
                const testData = {
                    gender: gender,
                    tendency: tendency,
                    totalScores: scores,
                    topTendency: {
                        name: topResults.topTendency,
                        score: topResults.topScore
                    },
                    secondTendency: {
                        name: topResults.secondTendency,
                        score: topResults.secondScore
                    },
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await db.collection('test_results').add(testData);
                console.log('테스트 결과가 성공적으로 저장되었습니다.');
                
            } catch (error) {
                console.error('결과 처리 중 오류 발생:', error);
            }
        }

        // 페이지 로드 시 실행
        window.addEventListener('load', processTestResult);

        // 모달 표시 함수
        function showModal(message) {
            const messageEl = document.getElementById('modalMessage');
            messageEl.innerHTML = message; // innerHTML을 사용하여 줄바꿈 태그가 적용되도록 함
            document.getElementById('modalOverlay').style.display = 'block';
            document.getElementById('warningModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('modalOverlay').style.display = 'none';
            document.getElementById('warningModal').style.display = 'none';
        }

        // BLUV 서비스로 이동
        function goToBluv() {
            // window.location.href = 'BLUV_URL';
        }

        // 이미지 저장
        async function saveImage() {
            try {
                const image = document.getElementById('resultImage');
                const response = await fetch(image.src);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'BLUV_테스트결과.png';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showModal('이미지가 기기에 저장되었습니다.');
            } catch (error) {
                console.error('이미지 저장 실패:', error);
                showModal('이미지 저장에 실패했습니다.');
            }
        }

        // 테스트 공유
        function shareTest() {
            const testUrl = 'https://bluv-test.com'; // 실제 테스트 URL로 변경 필요
            navigator.clipboard.writeText(testUrl).then(() => {
                const message = document.getElementById('modalMessage');
                message.innerHTML = '링크가 복사되었습니다.<br>친구에게 테스트를 공유해보세요!';
                document.getElementById('modalOverlay').style.display = 'block';
                document.getElementById('warningModal').style.display = 'block';
            });
        }

        // 테스트 다시하기 함수 수정
        function restartTest() {
            // localStorage 데이터 초기화
            localStorage.removeItem('gender');
            localStorage.removeItem('tendency');
            localStorage.removeItem('squestion1Answers');
            localStorage.removeItem('squestion2Answers');
            localStorage.removeItem('squestion3Answers');
            localStorage.removeItem('dquestion1Answers');
            localStorage.removeItem('dquestion2Answers');
            localStorage.removeItem('dquestion3Answers');
            localStorage.removeItem('subScores');  // 성향 점수도 초기화
            localStorage.removeItem('userGender');
            localStorage.removeItem('userTendency');

            // start.html로 이동
            window.location.href = 'start.html';
        }
    </script>
</body>
</html>
